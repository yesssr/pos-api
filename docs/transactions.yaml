paths:
  /transaction:
    post:
      summary: Create a transaction
      description: Create a new transaction with header and detail items; returns the transaction and optional invoice URL if payment is non-cash
      tags:
        - transactions
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTransactionInput"
      responses:
        "201":
          description: Successfully created transaction
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransactionCreateResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "./auth.yaml#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "./auth.yaml#/components/schemas/ErrorResponse"

  /transactions:
    get:
      summary: List transactions
      description: Get a paginated list of transactions within a date range (inclusive), ordered by date descending
      tags:
        - transactions
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: start_at
          schema:
            type: string
            format: date
          description: Start date (YYYY-MM-DD)
        - in: query
          name: end_at
          schema:
            type: string
            format: date
          description: End date (YYYY-MM-DD)
        - in: query
          name: page
          schema:
            type: integer
          description: Current page
        - in: query
          name: per_page
          schema:
            type: integer
          description: Items per page
      responses:
        "200":
          description: List of transactions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransactionListResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "./auth.yaml#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Pagination:
      type: object
      properties:
        current_page:
          type: integer
          example: 1
        per_page:
          type: integer
          example: 10
        total_pages:
          type: integer
          nullable: true
          example: 5

    PaymentMethod:
      type: string
      description: Transaction payment method
      enum:
        - cash
        - qris
        - credit
        - debit
      example: cash

    PaymentStatus:
      type: string
      description: Transaction payment status
      enum:
        - pending
        - paid
        - failed
      example: paid

    Transaction:
      type: object
      description: Full transaction record
      properties:
        id:
          type: string
          format: uuid
          example: 11111111-1111-1111-1111-111111111111
        id_user:
          type: string
          format: uuid
          example: 22222222-2222-2222-2222-222222222222
        id_customer:
          type: string
          format: uuid
          nullable: true
          example: 33333333-3333-3333-3333-333333333333
        date:
          type: string
          format: date-time
          example: 2025-01-01T12:00:00Z
        total:
          type: string
          description: Numeric as string representation
          example: "250000"
        payment_method:
          $ref: "#/components/schemas/PaymentMethod"
        payment_status:
          $ref: "#/components/schemas/PaymentStatus"
        id_transaction_gateway:
          type: string
          nullable: true
          example: "inv_abc123"
        created_at:
          type: string
          format: date-time
          example: 2025-01-01T12:00:00Z
        updated_at:
          type: string
          format: date-time
          example: 2025-01-01T12:05:00Z

    ListTransactionsRow:
      type: object
      description: Row returned by list query with joined customer name and cashier username
      properties:
        id:
          type: string
          format: uuid
          example: 11111111-1111-1111-1111-111111111111
        id_user:
          type: string
          format: uuid
          example: 22222222-2222-2222-2222-222222222222
        id_customer:
          type: string
          format: uuid
          nullable: true
          example: 33333333-3333-3333-3333-333333333333
        total:
          type: string
          description: Numeric as string representation
          example: "250000"
        date:
          type: string
          format: date-time
          example: 2025-01-01T12:00:00Z
        payment_method:
          $ref: "#/components/schemas/PaymentMethod"
        payment_status:
          $ref: "#/components/schemas/PaymentStatus"
        id_transaction_gateway:
          type: string
          nullable: true
          example: "inv_abc123"
        customer_name:
          type: string
          nullable: true
          example: "Alice Cooper"
        cashier:
          type: string
          example: "cashier01"

    GetDetailTransactionRow:
      type: object
      description: Detail transaction row with product name
      properties:
        id:
          type: string
          format: uuid
          example: 44444444-4444-4444-4444-444444444444
        id_transaction:
          type: string
          format: uuid
          example: 11111111-1111-1111-1111-111111111111
        id_product:
          type: string
          format: uuid
          example: 55555555-5555-5555-5555-555555555555
        qty:
          type: integer
          example: 2
        price:
          type: string
          description: Numeric as string representation
          example: "100000"
        subtotal:
          type: string
          description: Numeric as string representation
          example: "200000"
        product_name:
          type: string
          example: "Coffee"

    Item:
      type: object
      description: Line item used when creating a transaction
      properties:
        id_product:
          type: string
          format: uuid
          example: 55555555-5555-5555-5555-555555555555
        qty:
          type: integer
          minimum: 1
          example: 2
      required:
        - id_product
        - qty

    CreateTransactionInput:
      type: object
      description: Request body for creating a transaction
      properties:
        id_customer:
          type: string
          format: uuid
          nullable: true
          description: Optional customer ID
          example: 33333333-3333-3333-3333-333333333333
        payment_method:
          type: string
          description: One of cash, qris, credit, debit
          enum:
            - cash
            - qris
            - credit
            - debit
          example: cash
        items:
          type: array
          items:
            $ref: "#/components/schemas/Item"
      required:
        - payment_method
        - items

    TransactionCreateResponse:
      type: object
      description: Success envelope returning created transaction and optional invoice URL
      properties:
        success:
          type: boolean
          example: true
        status_code:
          type: integer
          example: 201
        message:
          type: string
          example: Successfully created transaction
        data:
          type: object
          properties:
            invoice_url:
              type: string
              nullable: true
              example: "https://gateway.example.com/invoices/abc123"
            transaction:
              $ref: "#/components/schemas/Transaction"

    TransactionListResponse:
      type: object
      description: Success envelope returning a list of transactions with pagination
      properties:
        success:
          type: boolean
          example: true
        status_code:
          type: integer
          example: 200
        message:
          type: string
          example: List of transactions
        data:
          type: array
          items:
            $ref: "#/components/schemas/ListTransactionsRow"
        pagination:
          $ref: "#/components/schemas/Pagination"
